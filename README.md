# Kartica Flashcards

Простое SPA для изучения слов с помощью флешкарточек. Приложение адаптировано под мобильные устройства, может быть установлено как PWA и поддерживает кастомизацию темы через Telegram WebApp API.

Основные возможности:

- просмотр готовых тем с карточками и запуск режима обучения;
- автоматическое сохранение истории открытых групп и быстрый доступ к ним в профиле;
- добавление групп в избранное и синхронизация отметок с сервером;
- REST API для чтения и создания групп/карточек, обновления истории и лайков.

## Требования

- Node.js 18+

## Установка зависимостей

```bash
npm install
```

## Локальный запуск

1. Примените миграции и запустите сервер:
   ```bash
   npm start
   ```
   При первом запуске сервер автоматически создаст файл базы данных `prisma/dev.db` и применит миграцию.
2. Откройте приложение по адресу `http://localhost:3000`. Бэкенд отдаёт как API, так и статические файлы фронтенда, поэтому дополнительный фронтенд-сервер не требуется.
3. Документация API доступна по адресу `http://localhost:3000/api/docs`, OpenAPI-спецификация — по `http://localhost:3000/api/openapi.yaml`.

### Сидинг тестовых данных

Чтобы наполнить базу тестовой группой карточек «English», выполните:

```bash
npm run seed
```

Скрипт перезапишет содержимое таблиц и создаст 20 карточек с фразовыми глаголами. Перед заполнением он пытается применить миграции, а если каталог `prisma/migrations` отсутствует, синхронизирует схему через `prisma db push`.

### Переменные окружения

- `PORT` — порт HTTP-сервера (по умолчанию `3000`).
- `DATABASE_URL` — путь к файлу SQLite (по умолчанию `file:./prisma/dev.db`).
- `TELEGRAM_BOT_SECRET` — токен вашего бота, используется для проверки `X-Telegram-Data`.

### Аутентификация запросов

Гостевые запросы на чтение (`GET /api/groups`, `GET /api/groups/{groupId}`, `GET /api/groups/{groupId}/cards`, `GET /api/users/{telegramId}`) доступны без заголовка `X-Telegram-Data` — так можно посмотреть карточки и публичный профиль даже вне Telegram.

Все остальные эндпоинты (`/api/me`, создание групп и карточек, отметки «нравится» и история изучения) требуют заголовка `X-Telegram-Data` с оригинальной строкой `initData`, которую Telegram WebApp передаёт клиенту. Сервер проверяет подпись при помощи `TELEGRAM_BOT_SECRET` и автоматически создаёт/обновляет пользователя по его `telegramId`.

Для локальной отладки откройте приложение внутри Telegram-клиента, получите `window.Telegram.WebApp.initData` и пробрасывайте его в запросы с фронтенда. Для защищённых эндпоинтов без заголовка сервер вернёт `403 Access denied`.

### Основные эндпоинты

| Метод | Путь | Описание |
| --- | --- | --- |
| `GET` | `/api/groups` | Список групп вместе с карточками и признаком `isLiked`. |
| `POST` | `/api/groups` | Создание новой группы. |
| `GET` | `/api/groups/{groupId}` | Получение группы по идентификатору. |
| `POST` | `/api/groups/{groupId}/cards` | Добавление карточки в выбранную группу. |
| `GET` | `/api/users/{telegramId}` | Публичные данные пользователя по Telegram ID. |
| `POST` | `/api/groups/{groupId}/history` | Фиксация факта открытия группы текущим пользователем. |
| `POST`/`DELETE` | `/api/groups/{groupId}/like` | Добавление или удаление группы из избранного. |
| `GET` | `/api/me` | Профиль пользователя: история и избранные группы. |

> ⚠️ Профиль, история и избранное доступны только после валидации `X-Telegram-Data`. Без авторизации API отдаёт лишь публичные данные о группах и карточках.

## Запуск в Docker

1. Соберите образ:
   ```bash
   docker build -t kartica .
   ```
2. Запустите контейнер:
   ```bash
   docker run -p 3000:3000 kartica
   ```
   При старте контейнер выполнит миграции и сидинговый скрипт, после чего запустит бэкенд, который раздаёт статический фронтенд и API.

## Обновление и деплой

Для выката на сервер достаточно собрать Docker-образ из репозитория и запустить его на целевой инфраструктуре. При каждом запуске контейнера база данных будет автоматически создана (если её ещё нет) и заполнена демо-данными из сида; для сохранения состояния используйте volume, примонтированный к `/app/prisma`.
