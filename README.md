# Kartica Flashcards

Современное SPA на Vite + Vue для изучения слов с помощью флешкарточек. Интерфейс адаптирован под мобильные устройства, может быть установлен как PWA и поддерживает кастомизацию темы через Telegram WebApp API.

## Требования

- Node.js 18+
- npm 9+

## Клиент (Vite + Vue)

1. Установите зависимости:
   ```bash
   npm install
   ```
2. Скопируйте переменные окружения и укажите адрес API (по умолчанию сервер Express слушает `http://localhost:4000`):
   ```bash
   cp .env.example .env
   # при необходимости отредактируйте значение VITE_API_BASE_URL
   ```
3. Запустите режим разработки с горячей перезагрузкой:
   ```bash
   npm run dev
   ```
   По умолчанию приложение будет доступно по адресу, который напечатает Vite (обычно `http://localhost:5173`).
4. Для предпросмотра production-сборки выполните:
   ```bash
   npm run build
   npm run preview
   ```

Сервис-воркер регистрируется автоматически после загрузки страницы, поэтому приложение можно установить как PWA.

## API (Express + Prisma)

API находится в директории `api/` и использует SQLite-базу данных (файл `api/prisma/dev.db`).

### Подготовка базы данных

1. Перейдите в папку API:
   ```bash
   cd api
   ```
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Примените миграции (при первом запуске создастся файл базы данных):
   ```bash
   npx prisma migrate dev --name init
   ```
4. Заполните базу стартовыми данными:
   ```bash
   npm run seed
   ```
   Скрипт создаст группу «Английский. Животные» с 20 карточками.

### Запуск сервера

```bash
npm run dev
```

По умолчанию сервер слушает порт `4000`.

### Маршруты

- `GET /groups` — список групп с пагинацией (`page`, `pageSize`).
- `GET /groups/:id` — подробности группы и связанные карточки.
- `GET /cards` — список карточек с пагинацией (`page`, `pageSize`).
- `GET /cards/:id` — отдельная карточка.

Публичные GET-маршруты работают без дополнительного middleware.

#### Администрирование

Операции изменения данных требуют действительного токена администратора (заголовок `Authorization: Bearer <token>`). Токен действует 12 часов, выдаётся маршрутом `POST /auth/token` на основе уникального идентификатора пользователя, который хранится на клиенте. Сервер привязывает этот идентификатор к группе и проверяет, что текущий пользователь является её владельцем:

- `POST /groups` — создание новой группы; владельцем становится пользователь, для которого был выпущен токен.
- `PUT /groups/:id` — обновление названия и описания группы, доступно только владельцу.
- `PUT /groups/:id/cards` — замена списка карточек группы, доступно только владельцу.
- `DELETE /groups/:id` — удаление группы, доступно только владельцу.

### Админ-панель и авторизация

Административный интерфейс доступен по пути `/admin` клиентского приложения и использует краткоживущий токен вместо классической сессии.

1. Задайте переменную окружения `ADMIN_TOKEN_SECRET` — любая достаточно длинная строка, на основе которой сервер подпишет токен администратора. Срок действия токена фиксирован и составляет 12 часов.
2. При необходимости настройте список разрешённых доменов через `ADMIN_ALLOWED_ORIGINS`.

В профиле основного приложения появилась кнопка «Перейти к созданию». При первом открытии клиент создаёт уникальный идентификатор пользователя, случайный секрет **и токен владельца**, сохраняет их в браузере и использует для подтверждения прав владельца. При нажатии кнопки фронтенд отправляет запрос `POST /auth/token` с этими данными и получает токен, после чего формирует ссылку вида `https://example.com/admin?token=...`. После открытия ссылки:

- админ-панель считывает токен из URL, сохраняет его в браузере и очищает адресную строку;
- все последующие запросы к защищённым маршрутам (`/auth/session`, `/groups`, `/groups/:id/cards` и т.д.) выполняются с заголовком `Authorization: Bearer <token>`;
- когда 12-часовой срок действия токена заканчивается, нужно запросить новую ссылку из профиля мини-приложения.

Админ-панель после входа автоматически обновляет токен владельца через маршрут `/auth/claim-token` и показывает его на отдельной вкладке — сохраните значение в том же браузере, иначе повторно получить ссылку не получится. Если токен владельца отсутствует, запрос на выдачу админ-ссылки завершается с ошибкой.

После авторизации интерфейс админ-панели показывает только те группы, у которых `ownerId` совпадает с идентификатором текущего владельца, поэтому чужой контент не отображается и не может быть выбран для редактирования.

Группы, созданные до появления владельцев, остаются доступными только для чтения. Новые группы автоматически привязываются к идентификатору пользователя, для которого был выпущен токен, — редактировать и удалять их может только владелец.

Дополнительные маршруты авторизации:

- `POST /auth/token` — выдача токена администратора. Ожидает JSON `{ "userId": "...", "secret": "...", "claimToken": "...", "profile": { "displayName": "..." } }`. Если группы уже принадлежат указанному `userId`, то без корректного `claimToken` запрос будет отклонён.
- `POST /auth/claim-token` — обновление токена владельца для уже аутентифицированного администратора.
- `GET /auth/session` — проверка токена и получение данных авторизованного пользователя.
- `POST /auth/logout` — завершение сеанса на клиенте (для удаления локального токена достаточно очистить хранилище).

## Совместный запуск клиента и API

1. Запустите API (см. раздел выше), по умолчанию он слушает порт `4000`.
2. В отдельном терминале запустите фронтенд (`npm run dev`).
3. Откройте приложение Vite; список групп и карточки будут подгружаться из базы данных через API с поддержкой пагинации.

## Запуск в Docker

Docker-образ включает production-сборку фронтенда и сервер Express, поэтому при запуске контейнера приложение доступно на порту
`4000`, а API обрабатывает запросы по пути `/api`.

1. Соберите образ:
   ```bash
   docker build -t kartica-app .
   ```
2. Запустите контейнер, пробросив порт и подключив директорию с базой данных из проекта:
   ```bash
   docker run \
     -p 4000:4000 \
     -v "$(pwd)/api/prisma:/app/api/prisma" \
     --name kartica-app \
     kartica-app
   ```

Приложение будет доступно по адресу `http://localhost:4000/`, база данных `dev.db` сохранится в папке `api/prisma` вашего проекта.

### Telegram-бот администратора

API запускает Telegram-бота из файла `api/bot.js` в том же процессе. Чтобы бот начал принимать команды, укажите токен и (опционально)
адрес мини-приложения в переменных окружения:

```bash
ADMIN_TELEGRAM_BOT_TOKEN=000000000:example-token
# необязательно, но позволит кнопке открыть мини-приложение прямо из Telegram
ADMIN_TELEGRAM_MINIAPP_URL=https://t.me/your_bot/miniapp
# при использовании тестового сервера задайте отдельную ссылку, если она отличается
# ADMIN_TELEGRAM_TEST_MINIAPP_URL=https://t.me/your_bot/testapp
# если вы используете тестовый сервер Bot API, включите его и при необходимости переопределите базовый URL
# ADMIN_TELEGRAM_BOT_USE_TEST_ENV=true
# ADMIN_TELEGRAM_BOT_API_BASE_URL=https://api.telegram.org
```

После запуска сервера API в логах появится сообщение `Telegram bot polling started.`. Команда `/start` отправит приветствие и кнопку
с miniapp, если указан URL. Если Bot API отклонит ссылку (например, с тестового сервера), бот предупредит об этом в логах и повторно
отправит приветствие без кнопки.
