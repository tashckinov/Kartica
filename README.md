# Kartica Flashcards

Современное SPA на Vite + Vue для изучения слов с помощью флешкарточек. Интерфейс адаптирован под мобильные устройства, может быть установлен как PWA и поддерживает кастомизацию темы через Telegram WebApp API.

## Требования

- Node.js 18+
- npm 9+

## Клиент (Vite + Vue)

1. Установите зависимости:
   ```bash
   npm install
   ```
2. Скопируйте переменные окружения и укажите адрес API (по умолчанию сервер Express слушает `http://localhost:4000`):
   ```bash
   cp .env.example .env
   # при необходимости отредактируйте значение VITE_API_BASE_URL
   ```
3. Запустите режим разработки с горячей перезагрузкой:
   ```bash
   npm run dev
   ```
   По умолчанию приложение будет доступно по адресу, который напечатает Vite (обычно `http://localhost:5173`).
4. Для предпросмотра production-сборки выполните:
   ```bash
   npm run build
   npm run preview
   ```

Сервис-воркер регистрируется автоматически после загрузки страницы, поэтому приложение можно установить как PWA.

## API (Express + Prisma)

API находится в директории `api/` и использует SQLite-базу данных (файл `api/prisma/dev.db`).

### Подготовка базы данных

1. Перейдите в папку API:
   ```bash
   cd api
   ```
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Примените миграции (при первом запуске создастся файл базы данных):
   ```bash
   npx prisma migrate dev --name init
   ```
4. Заполните базу стартовыми данными:
   ```bash
   npm run seed
   ```
   Скрипт создаст группу «Английский. Животные» с 20 карточками.

### Запуск сервера

```bash
npm run dev
```

По умолчанию сервер слушает порт `4000`.

### Маршруты

- `GET /groups` — список групп с пагинацией (`page`, `pageSize`).
- `GET /groups/:id` — подробности группы и связанные карточки.
- `GET /cards` — список карточек с пагинацией (`page`, `pageSize`).
- `GET /cards/:id` — отдельная карточка.

Публичные GET-маршруты работают без дополнительного middleware.

#### Администрирование

Операции изменения данных требуют действительного токена администратора (заголовок `Authorization: Bearer <token>`). Токен действует 12 часов, выдаётся маршрутом `POST /auth/token` после проверки `initData`, полученного от Telegram, и связывается с Telegram ID пользователя. Сервер также гарантирует, что текущий пользователь является владельцем группы:

- `POST /groups` — создание новой группы; в качестве владельца сохраняется Telegram ID авторизованного пользователя.
- `PUT /groups/:id` — обновление названия и описания группы, доступно только владельцу.
- `PUT /groups/:id/cards` — замена списка карточек группы, доступно только владельцу.
- `DELETE /groups/:id` — удаление группы, доступно только владельцу.

### Админ-панель и авторизация

Административный интерфейс доступен по пути `/admin` клиентского приложения и использует краткоживущий токен вместо классической сессии.

1. Создайте бота в `@BotFather` и получите токен.
2. Установите переменную окружения `ADMIN_TELEGRAM_BOT_TOKEN` на сервере API — она требуется для проверки подписи данных, которые Telegram передаёт мини-приложению (`initData`).
3. Задайте секрет подписи `ADMIN_TOKEN_SECRET` — любая достаточно длинная строка, на основе которой сервер подпишет токен администратора. Срок действия токена фиксирован и составляет 12 часов.
4. При необходимости ограничьте доступ списком `ADMIN_TELEGRAM_ALLOWED_USER_IDS` (через запятую) и настройте допустимый возраст данных `ADMIN_TELEGRAM_LOGIN_MAX_AGE_SECONDS` (по умолчанию 600 секунд).
5. Добавьте домен приложения в список разрешённых доменов для бота через `@BotFather` (`/setdomain`), чтобы Telegram передавал `initData` мини-приложению.

В профиле основного приложения появилась кнопка «Перейти к созданию». При нажатии фронтенд отправляет в `POST /auth/token` исходную строку `initData`; сервер проверяет подпись Telegram и возвращает токен. Клиент формирует ссылку вида `https://example.com/admin?token=...`. После открытия ссылки:

- админ-панель считывает токен из URL, сохраняет его в браузере и очищает адресную строку;
- все последующие запросы к защищённым маршрутам (`/auth/session`, `/groups`, `/groups/:id/cards` и т.д.) выполняются с заголовком `Authorization: Bearer <token>`;
- когда 12-часовой срок действия токена заканчивается, нужно запросить новую ссылку из профиля мини-приложения.

Группы, созданные до появления владельцев, остаются доступными только для чтения. Новые группы автоматически привязываются к Telegram ID автора; редактировать и удалять их может только владелец.

Дополнительные маршруты авторизации:

- `POST /auth/token` — выдача токена администратора по подписанным данным Telegram (`initData`).
- `GET /auth/session` — проверка токена и получение данных авторизованного пользователя.
- `POST /auth/logout` — завершение сеанса на клиенте (для удаления локального токена достаточно очистить хранилище).

## Совместный запуск клиента и API

1. Запустите API (см. раздел выше), по умолчанию он слушает порт `4000`.
2. В отдельном терминале запустите фронтенд (`npm run dev`).
3. Откройте приложение Vite; список групп и карточки будут подгружаться из базы данных через API с поддержкой пагинации.
