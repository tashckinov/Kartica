# Kartica Flashcards

Современное SPA на Vite + Vue для изучения слов с помощью флешкарточек. Интерфейс адаптирован под мобильные устройства, может быть установлен как PWA и поддерживает кастомизацию темы через Telegram WebApp API.

## Требования

- Node.js 18+
- npm 9+

## Клиент (Vite + Vue)

1. Установите зависимости:
   ```bash
   npm install
   ```
2. Скопируйте переменные окружения и укажите адрес API (по умолчанию сервер Express слушает `http://localhost:4000`):
   ```bash
   cp .env.example .env
   # при необходимости отредактируйте значение VITE_API_BASE_URL
   ```
3. Запустите режим разработки с горячей перезагрузкой:
   ```bash
   npm run dev
   ```
   По умолчанию приложение будет доступно по адресу, который напечатает Vite (обычно `http://localhost:5173`).
4. Для предпросмотра production-сборки выполните:
   ```bash
   npm run build
   npm run preview
   ```

Сервис-воркер регистрируется автоматически после загрузки страницы, поэтому приложение можно установить как PWA.

## API (Express + Prisma)

API находится в директории `api/` и использует SQLite-базу данных (файл `api/prisma/dev.db`).

### Подготовка базы данных

1. Перейдите в папку API:
   ```bash
   cd api
   ```
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Примените миграции (при первом запуске создастся файл базы данных):
   ```bash
   npx prisma migrate dev --name init
   ```
4. Заполните базу стартовыми данными:
   ```bash
   npm run seed
   ```
   Скрипт создаст группу «Английский. Животные» с 20 карточками.

### Запуск сервера

```bash
npm run dev
```

По умолчанию сервер слушает порт `4000`.

### Маршруты

- `GET /groups` — список групп с пагинацией (`page`, `pageSize`).
- `GET /groups/:id` — подробности группы и связанные карточки.
- `GET /cards` — список карточек с пагинацией (`page`, `pageSize`).
- `GET /cards/:id` — отдельная карточка.

Публичные GET-маршруты работают без дополнительного middleware.

#### Администрирование

Операции изменения данных требуют действующей сессии администратора (cookie `kartica_admin_session`), созданной после успешной авторизации через Telegram. Дополнительно сервер проверяет, что текущий пользователь является владельцем группы:

- `POST /groups` — создание новой группы; в качестве владельца сохраняется Telegram ID авторизованного пользователя.
- `PUT /groups/:id` — обновление названия и описания группы, доступно только владельцу.
- `PUT /groups/:id/cards` — замена списка карточек группы, доступно только владельцу.
- `DELETE /groups/:id` — удаление группы, доступно только владельцу.

### Админ-панель и авторизация

Административный интерфейс доступен по пути `/admin` клиентского приложения и использует авторизацию через Telegram. Вход возможен как внутри Telegram Mini App, так и из любого браузера через официальный Telegram Login Widget.

1. Создайте бота в `@BotFather` и получите токен.
2. Установите переменную окружения `ADMIN_TELEGRAM_BOT_TOKEN` на сервере API — она используется для проверки подписи данных авторизации Telegram.
3. Укажите список разрешённых администраторов в `ADMIN_TELEGRAM_ALLOWED_USER_IDS` (через запятую, значения — числовые идентификаторы пользователей Telegram). Если список пуст, доступ получат все пользователи, прошедшие проверку подписи.
4. При необходимости настройте допустимый возраст данных авторизации параметром `ADMIN_TELEGRAM_LOGIN_MAX_AGE_SECONDS` (по умолчанию 600 секунд).
5. Чтобы отрисовать кнопку внешнего входа, укажите на фронтенде переменную `VITE_ADMIN_TELEGRAM_BOT_USERNAME` (без символа `@`) и добавьте домен приложения в список разрешённых доменов виджета через `@BotFather` (`/setdomain`).

Сервер принимает исходную строку `initData`, которую Telegram передаёт мини-приложению (например, через `tgWebAppInitData` или `tgWebAppData`), а также подпись, сформированную Telegram Login Widget. После успешной проверки создаётся сессия администратора, и запросы к `/groups` и другим защищённым маршрутам выполняются с cookie `kartica_admin_session`. Каждая созданная группа связывается с Telegram ID автора; изменять или удалять группу может только её владелец. Ранние группы без владельца остаются доступными только для чтения.

## Совместный запуск клиента и API

1. Запустите API (см. раздел выше), по умолчанию он слушает порт `4000`.
2. В отдельном терминале запустите фронтенд (`npm run dev`).
3. Откройте приложение Vite; список групп и карточки будут подгружаться из базы данных через API с поддержкой пагинации.
